import streamlit as st
from openai import OpenAI

# --- 1. ç½‘é¡µåŸºç¡€è®¾ç½® ---
st.set_page_config(page_title="å‚è€ƒæ–‡çŒ®è§„èŒƒåŒ–åŠ©æ‰‹", page_icon="ğŸ“š")

# --- 2. ä¾§è¾¹æ ï¼šè¾“å…¥ Key çš„åœ°æ–¹ ---
with st.sidebar:
    st.header("ğŸ”‘ èº«ä»½éªŒè¯")
    # ä¸ºäº†æ–¹ä¾¿ä½ ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ç½‘é¡µä¸Šè¾“å…¥ Keyï¼Œä¸ç”¨é…ç½®å¤æ‚æ–‡ä»¶
    api_key = st.text_input("è¯·è¾“å…¥ DeepSeek API Key", type="password", placeholder="sk-å¼€å¤´çš„é‚£ä¸²ä¹±ç ")
    st.markdown("---")
    st.write("**å…³äºå·¥å…·**")
    st.caption("æœ¬å·¥å…·ä¸“ä¸ºç ”ç©¶ç”Ÿå­¦æœ¯å†™ä½œè®¾è®¡ï¼Œæ”¯æŒä¸€é”®å°†æ‚ä¹±å¼•æ–‡è½¬æ¢ä¸º GB/T 7714 æ ¼å¼ã€‚")

# --- 3. ä¸»é¡µé¢å†…å®¹ ---
st.title("ğŸ“š å‚è€ƒæ–‡çŒ® AI æ’ç‰ˆå·¥å…·")
st.markdown("### âœï¸ æŠŠä½ ä¹±ç³Ÿç³Ÿçš„å¼•ç”¨ç²˜è´´åœ¨ä¸‹é¢ï¼š")

# è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ–‡æœ¬è¾“å…¥æ¡†
user_input = st.text_area(
    "è¾“å…¥åŒºåŸŸ",
    height=200,
    placeholder="ä¾‹å¦‚ï¼š\nå¶å˜‰è¹. æ±‰é­å…­æœè¯—è®²å½•[M]. æ²³åŒ—æ•™è‚²å‡ºç‰ˆç¤¾, 1997.\næˆ–è€…ç›´æ¥æŠŠçŸ¥ç½‘å¤åˆ¶æ¥çš„ä¹±ç ç²˜åœ¨è¿™é‡Œ..."
)

# --- 4. æ ¸å¿ƒé€»è¾‘ï¼šå½“æŒ‰é’®è¢«ç‚¹å‡»æ—¶ ---
if st.button("âœ¨ ç«‹å³æ’ç‰ˆ (GB/T 7714)", type="primary"):
    # æ£€æŸ¥ä¸¤ä¸ªå¿…è¦æ¡ä»¶ï¼šæœ‰æ²¡æœ‰è¾“å…¥å†…å®¹ï¼Ÿæœ‰æ²¡æœ‰å¡« Keyï¼Ÿ
    if not user_input:
        st.warning("âš ï¸ ä½ è¿˜æ²¡æœ‰è¾“å…¥ä»»ä½•å¼•ç”¨å†…å®¹å“¦ï¼")
    elif not api_key:
        st.error("ğŸš« è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ è¾“å…¥ä½ çš„ DeepSeek API Key æ‰èƒ½å¯åŠ¨ AIã€‚")
    else:
        try:
            # æ˜¾ç¤ºä¸€ä¸ªè½¬åœˆåœˆçš„åŠ è½½åŠ¨ç”»
            with st.spinner("ğŸ¤– AI æ­£åœ¨æŸ¥é˜…å­¦æœ¯è§„èŒƒï¼Œè¯·ç¨å€™..."):
                
                # è¿æ¥ DeepSeek å¤§è„‘
                client = OpenAI(api_key=api_key, base_url="https://api.siliconflow.cn/v1")

                # ç»™ AI ä¸‹è¾¾çš„â€œå‚¬çœ æŒ‡ä»¤â€ (Prompt)
                system_prompt = """
                ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯ç¼–è¾‘ï¼Œç²¾é€š GB/T 7714-2015 å‚è€ƒæ–‡çŒ®è‘—å½•è§„åˆ™ã€‚
                ä»»åŠ¡ï¼šå°†ç”¨æˆ·æä¾›çš„å¼•æ–‡ä¿¡æ¯ï¼Œé€æ¡ä¿®æ­£å¹¶æ ¼å¼åŒ–ä¸ºæ ‡å‡†çš„ GB/T 7714 æ ¼å¼ã€‚
                è¦æ±‚ï¼š
                1. ä¿®æ­£æ ‡ç‚¹ï¼ˆä½¿ç”¨åŠè§’æ ‡ç‚¹ï¼‰ã€‚
                2. è¡¥å…¨æ ‡è¯†ä»£ç ï¼ˆå¦‚ [M], [J]ï¼‰ã€‚
                3. åªè¾“å‡ºç»“æœï¼Œä¸è¦ä»»ä½•åºŸè¯ã€‚
                """

                # å‘é€è¯·æ±‚
                response = client.chat.completions.create(
                    model="deepseek-ai/DeepSeek-V3",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_input},
                    ],
                    stream=False
                )
                
                # è·å–ç»“æœ
                result = response.choices[0].message.content

            # --- 5. å±•ç¤ºç»“æœ ---
            st.success("âœ… æ’ç‰ˆå®Œæˆï¼ç‚¹å‡»å³ä¸Šè§’å¤åˆ¶å›¾æ ‡å³å¯ä½¿ç”¨ã€‚")
            st.code(result, language="text") # æ˜¾ç¤ºä¸ºä»£ç å—ï¼Œæ–¹ä¾¿å¤åˆ¶

        except Exception as e:
            st.error(f"å‡ºé”™å•¦ï¼š{e}")
            st.caption("è¯·æ£€æŸ¥ä½ çš„ API Key æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…ç½‘ç»œæ˜¯å¦é€šç•…ã€‚")